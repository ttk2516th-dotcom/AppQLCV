<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tr·ª£ l√Ω Gi√°o vi√™n</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
/* ======================================================
   BASELINE v1.3.3 ‚Äì KH√îNG S·ª¨A LOGIC
====================================================== */
.today { background:#dbeafe }
.other-month { color:#9ca3af }
.dot {
  width:6px;
  height:6px;
  border-radius:50%;
  display:inline-block;
  margin-right:2px;
}
.status {
  font-size:12px;
  padding:2px 6px;
  border-radius:999px;
  color:#fff;
}

/* ===== selected day highlight (ADD v1.3.4) ===== */
.selected-day {
  outline:2px solid #2563eb;
  outline-offset:-2px;
}

/* ===== heat map (ADD v1.3.4) ===== */
.heat-1 { background:#f8fafc }
.heat-2 { background:#eef2ff }
.heat-3 { background:#e0e7ff }

/* ======================================================
   BOTTOM BAR ‚Äì v1.3.3
====================================================== */
.bottom-bar {
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:72px;
  background:#fff;
  border-top-left-radius:24px;
  border-top-right-radius:24px;
  box-shadow:0 -2px 10px rgba(0,0,0,.08);
  display:flex;
  justify-content:space-around;
  align-items:center;
  z-index:1000;
}
.bottom-bar::before {
  content:"";
  position:absolute;
  top:-28px;
  left:50%;
  transform:translateX(-50%);
  width:84px;
  height:56px;
  background:#fff;
  border-radius:0 0 42px 42px;
  box-shadow:0 -4px 10px rgba(0,0,0,.08);
}

/* ======================================================
   CENTER PLUS ‚Äì v1.3.3 UI POLISH
====================================================== */
.center-plus {
  position:fixed;
  bottom:36px;
  left:50%;
  transform:translateX(-50%);
  width:66px;
  height:66px;
  border-radius:999px;
  background:linear-gradient(145deg,#3b82f6,#2563eb);
  color:#fff;
  font-size:36px;
  font-weight:600;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1100;
  box-shadow:
    0 12px 28px rgba(37,99,235,.35),
    inset 0 1px 0 rgba(255,255,255,.35);
}
.center-plus:active {
  transform:translateX(-50%) scale(.96);
}

/* ======================================================
   MODAL ‚Äì v1.3.3
====================================================== */
.modal-bg {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.modal {
  background:#fff;
  width:92%;
  max-width:540px;
  border-radius:16px;
  padding:16px;
  max-height:90vh;
  overflow:auto;
}

/* ======================================================
   ADD v1.3.6 ‚Äì TIMELINE / CONFLICT / WEEK (CSS ONLY)
   (KH√îNG ·∫¢NH H∆Ø·ªûNG LOGIC C≈®)
====================================================== */
/* timeline day */
.timeline-wrap { border-left:2px solid #e5e7eb; padding-left:10px; }
.time-row { position:relative; height:48px; border-bottom:1px dashed #e5e7eb; }
.time-label { position:absolute; left:-44px; top:0; font-size:11px; color:#6b7280; }
.task-block {
  position:absolute; left:0; right:6px;
  border-radius:8px; padding:4px 6px; font-size:12px; color:#fff;
}
/* conflict warn */
.conflict { outline:2px solid #dc2626; }
/* week view */
.week-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
.week-col { border:1px solid #e5e7eb; border-radius:10px; padding:6px; }
.week-head { font-size:12px; font-weight:600; text-align:center; margin-bottom:4px; }
</style>
</head>

<body class="bg-gray-100 pb-24">

<div class="max-w-md mx-auto bg-white min-h-screen">
<header class="p-4 text-center font-bold text-xl border-b">
üìò Tr·ª£ l√Ω Gi√°o vi√™n
</header>

<main class="p-3">

<!-- ======================================================
     TAB: L·ªäCH TH√ÅNG
====================================================== -->
<section id="tab-month">

  <!-- ADD v1.3.4: ROLE FILTER -->
  <div id="roleFilter" class="flex flex-wrap gap-1 mb-2 text-xs"></div>

  <div class="flex justify-between mb-2">
    <button onclick="changeMonth(-1)">‚óÄ</button>
    <h2 id="monthTitle" class="font-semibold"></h2>
    <button onclick="changeMonth(1)">‚ñ∂</button>
  </div>

  <!-- WEEK HEADER (MONDAY FIRST) -->
  <div class="grid grid-cols-7 text-center text-xs font-semibold mb-1">
    <div>T2</div><div>T3</div><div>T4</div><div>T5</div>
    <div>T6</div><div>T7</div><div>CN</div>
  </div>

  <div id="monthGrid" class="grid grid-cols-7 gap-1"></div>
</section>

<!-- ======================================================
     TAB: L·ªäCH NG√ÄY
====================================================== -->
<section id="tab-day" class="hidden">
  <div class="flex justify-between items-center mb-2">
    <h2 id="dayTitle" class="font-semibold"></h2>
    <!-- ADD v1.3.6: Toggle list / timeline -->
    <button id="toggleDayViewBtn" class="text-xs underline">Danh s√°ch | Timeline</button>
  </div>

  <!-- v1.3.5 LIST VIEW (GI·ªÆ NGUY√äN) -->
  <div id="dayTasks" class="space-y-2 text-sm"></div>

  <!-- ADD v1.3.6: TIMELINE VIEW (·∫®N M·∫∂C ƒê·ªäNH) -->
  <div id="dayTimeline" class="timeline-wrap hidden"></div>
</section>

<!-- ======================================================
     ADD v1.3.6: TAB TU·∫¶N (·∫®N M·∫∂C ƒê·ªäNH)
====================================================== -->
<section id="tab-week" class="hidden">
  <div class="flex justify-between mb-2">
    <button onclick="changeWeek(-1)">‚óÄ</button>
    <h2 id="weekTitle" class="font-semibold"></h2>
    <button onclick="changeWeek(1)">‚ñ∂</button>
  </div>
  <div id="weekGrid" class="week-grid"></div>
</section>

</main>
</div>

<!-- CENTER PLUS -->
<button class="center-plus" onclick="openModal()">+</button>

<!-- ======================================================
     BOTTOM BAR
====================================================== -->
<div class="bottom-bar">
  <button onclick="showTab('month')">üìÖ<br><span class="text-xs">L·ªãch th√°ng</span></button>
  <button onclick="showTab('week')">üìÜ<br><span class="text-xs">Tu·∫ßn</span></button>
  <div style="width:72px"></div>
  <button onclick="showTab('day')">‚è∞<br><span class="text-xs">L·ªãch ng√†y</span></button>
  <button>‚öôÔ∏è<br><span class="text-xs">C√†i ƒë·∫∑t</span></button>
</div>

<!-- ======================================================
     MODAL: ADD / EDIT TASK (v1.3.5 ‚Äì GI·ªÆ NGUY√äN)
====================================================== -->
<div id="modalBg" class="modal-bg">
<div class="modal">
<h3 id="modalTitle" class="font-semibold mb-3">‚ûï Th√™m c√¥ng vi·ªác</h3>

<input id="mTitle" class="w-full border p-2 rounded mb-2" placeholder="T√™n c√¥ng vi·ªác">

<select id="mRole" class="w-full border p-2 rounded mb-2">
  <option value="GVDL">Gi√°o vi√™n d·∫°y l·ªõp</option>
  <option value="GVCN">Gi√°o vi√™n ch·ªß nhi·ªám</option>
  <option value="TTCM">T·ªï tr∆∞·ªüng chuy√™n m√¥n</option>
  <option value="DANG">ƒê·∫£ng vi√™n</option>
  <option value="DOAN">ƒêo√†n vi√™n</option>
  <option value="DOI">H·ªó tr·ª£ ƒê·ªôi</option>
  <option value="KHAC">Kh√°c</option>
</select>

<textarea id="mDetail" class="w-full border p-2 rounded mb-2" placeholder="Chi ti·∫øt c√¥ng vi·ªác"></textarea>

<label class="text-xs">Ng√†y b·∫Øt ƒë·∫ßu</label>
<input id="mStartDate" type="date" class="w-full border p-2 rounded mb-2">

<label class="text-xs">Gi·ªù b·∫Øt ƒë·∫ßu</label>
<input id="mStartTime" type="time" class="w-full border p-2 rounded mb-2">

<label class="text-xs">Ng√†y k·∫øt th√∫c</label>
<input id="mEndDate" type="date" class="w-full border p-2 rounded mb-2">

<label class="text-xs">Gi·ªù k·∫øt th√∫c</label>
<input id="mEndTime" type="time" class="w-full border p-2 rounded mb-3">

<div class="border p-2 rounded mb-2 text-sm">
<b>Ch·∫ø ƒë·ªô c√¥ng vi·ªác</b><br>
<label><input type="radio" name="mode" value="FIXED" checked> ƒê√∫ng h·∫°n</label><br>
<label><input type="radio" name="mode" value="FLEX"> Linh ƒë·ªông</label>
</div>

<div class="border p-2 rounded mb-2 text-sm">
<b>L·∫∑p l·∫°i</b><br>
<label><input type="radio" name="repeat" value="NONE" checked> Kh√¥ng l·∫∑p</label><br>
<label><input type="radio" name="repeat" value="DAILY"> Theo gi·ªù m·ªói ng√†y</label><br>
<label><input type="radio" name="repeat" value="WEEKLY"> Theo ng√†y trong tu·∫ßn</label><br>
<label><input type="radio" name="repeat" value="MONTHLY"> Theo ng√†y trong th√°ng</label>
</div>

<div class="border p-2 rounded mb-3 text-sm">
<b>üîî Th√¥ng b√°o</b><br>
<label><input type="checkbox" id="n1d"> Tr∆∞·ªõc 1 ng√†y</label><br>
<label><input type="checkbox" id="n1h"> Tr∆∞·ªõc 1 gi·ªù</label><br>
<label><input type="checkbox" id="nStart"> Khi b·∫Øt ƒë·∫ßu</label><br>
<label><input type="checkbox" id="nHalf"> Khi tr√¥i qua 50%</label><br>
<label><input type="checkbox" id="nEnd1d"> Tr∆∞·ªõc khi k·∫øt th√∫c 1 ng√†y</label><br>
<label><input type="checkbox" id="nEnd1h"> Tr∆∞·ªõc khi k·∫øt th√∫c 1 gi·ªù</label><br>
<label><input type="checkbox" id="nEnd"> Khi ƒë√£ k·∫øt th√∫c</label>
</div>

<div class="flex justify-end gap-3">
<button onclick="closeModal()">Hu·ª∑</button>
<button id="saveBtn" class="bg-blue-600 text-white px-4 py-2 rounded" onclick="saveTask()">L∆∞u</button>
</div>
</div>
</div>

<!-- ======================================================
     SCRIPT ‚Äì BASELINE v1.3.5 + APPEND v1.3.6 (JS TI·∫æP ·ªû PH·∫¶N 2)
====================================================== -->
<script>
/* ===== DATE UTILS (v1.3.3 ‚Äì GI·ªÆ NGUY√äN) ===== */
const pad = n => String(n).padStart(2,'0');
const toYMD = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

/* ===== ROLE COLOR (v1.3.3) ===== */
const ROLE_COLOR = {
  GVDL:'#2563eb',
  GVCN:'#16a34a',
  TTCM:'#7c3aed',
  DANG:'#dc2626',
  DOAN:'#f97316',
  DOI:'#06b6d4',
  KHAC:'#6b7280'
};

/* ===== ROLE LABEL (v1.3.4) ===== */
const ROLE_LABEL = {
  GVDL:'GVDL',
  GVCN:'GVCN',
  TTCM:'TTCM',
  DANG:'ƒê·∫£ng',
  DOAN:'ƒêo√†n',
  DOI:'ƒê·ªôi',
  KHAC:'Kh√°c'
};

/* ===== STATE (v1.3.5) ===== */
let tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
let viewDate = new Date();
let selectedDate = new Date();
let editingTaskId = null;
let activeRoles = new Set(Object.keys(ROLE_COLOR));

/* ===== ADD v1.3.6: DAY VIEW MODE ===== */
let dayViewMode = 'list'; // 'list' | 'timeline'

/* ===== ADD v1.3.6: WEEK VIEW STATE ===== */
let weekAnchorDate = new Date();

/* ======================================================
   (PH·∫¶N 2/2 TI·∫æP T·ª§C JS ‚Äì KH√îNG THI·∫æU D√íNG)
====================================================== */
/* ======================================================
   ROLE FILTER UI ‚Äì v1.3.4 (GI·ªÆ NGUY√äN)
====================================================== */
const roleFilter = document.getElementById('roleFilter');

function renderRoleFilter(){
  roleFilter.innerHTML = '';
  Object.keys(ROLE_COLOR).forEach(role=>{
    const btn = document.createElement('button');
    btn.textContent = ROLE_LABEL[role];
    btn.className = 'border px-2 py-0.5 rounded';
    btn.style.borderColor = ROLE_COLOR[role];
    if(activeRoles.has(role)) btn.style.background = '#dbeafe';

    btn.onclick = () => {
      activeRoles.has(role) ? activeRoles.delete(role) : activeRoles.add(role);
      renderRoleFilter();
      renderMonth();
    };
    roleFilter.appendChild(btn);
  });
}

/* ======================================================
   TAB CONTROL ‚Äì v1.3.5 (M·ªû R·ªòNG TAB TU·∫¶N)
====================================================== */
function showTab(tab){
  ['month','day','week'].forEach(t=>{
    document.getElementById('tab-'+t).classList.toggle('hidden', tab!==t);
  });
  if(tab==='day') renderDay();
  if(tab==='week') renderWeek();
}

/* ======================================================
   MONTH VIEW ‚Äì v1.3.5 (GI·ªÆ NGUY√äN)
====================================================== */
function changeMonth(step){
  viewDate.setMonth(viewDate.getMonth()+step);
  renderMonth();
}

function renderMonth(){
  monthGrid.innerHTML='';
  const y=viewDate.getFullYear();
  const m=viewDate.getMonth();
  monthTitle.innerText=`Th√°ng ${m+1}/${y}`;

  const firstDay=(new Date(y,m,1).getDay()+6)%7;
  const start=new Date(y,m,1-firstDay);

  for(let i=0;i<42;i++){
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    const ymd=toYMD(d);

    const cell=document.createElement('div');
    cell.className='border rounded p-1 text-xs min-h-[72px]';

    if(d.getMonth()!==m) cell.classList.add('other-month');
    if(ymd===toYMD(new Date())) cell.classList.add('today');
    if(ymd===toYMD(selectedDate)) cell.classList.add('selected-day');

    const dayTasks=tasks.filter(t =>
      t.startDate<=ymd &&
      t.endDate>=ymd &&
      activeRoles.has(t.role)
    );

    if(dayTasks.length>=4) cell.classList.add('heat-3');
    else if(dayTasks.length>=2) cell.classList.add('heat-2');
    else cell.classList.add('heat-1');

    cell.innerHTML=`<div>${d.getDate()}</div>`;

    dayTasks.forEach(t=>{
      const dot=document.createElement('span');
      dot.className='dot';
      dot.style.background=ROLE_COLOR[t.role];
      cell.appendChild(dot);
    });

    const count={};
    dayTasks.forEach(t=>count[t.role]=(count[t.role]||0)+1);
    Object.keys(count).forEach(role=>{
      const s=document.createElement('div');
      s.className='text-[10px] leading-tight';
      s.style.color=ROLE_COLOR[role];
      s.textContent=`${ROLE_LABEL[role]}√ó${count[role]}`;
      cell.appendChild(s);
    });

    cell.onclick=()=>{
      selectedDate=d;
      showTab('day');
      renderMonth();
    };
    monthGrid.appendChild(cell);
  }
}

/* ======================================================
   STATUS LOGIC ‚Äì v1.3.5 (GI·ªÆ NGUY√äN)
====================================================== */
function getStatus(task){
  const now=new Date();
  const s=new Date(`${task.startDate}T${task.startTime}`);
  const e=new Date(`${task.endDate}T${task.endTime}`);

  if(now < s - 2*864e5) return ['Ch∆∞a b·∫Øt ƒë·∫ßu','#6b7280'];
  if(now < s) return ['S·∫Øp b·∫Øt ƒë·∫ßu','#f59e0b'];
  if(now >= s && now <= e - 864e5) return ['ƒêang di·ªÖn ra','#2563eb'];
  if(now > e - 864e5 && now <= e) return ['S·∫Øp k·∫øt th√∫c','#dc2626'];
  return ['K·∫øt th√∫c','#374151'];
}

/* ======================================================
   DAY VIEW ‚Äì v1.3.5 + ADD v1.3.6 (TIMELINE + QUICK)
====================================================== */
document.getElementById('toggleDayViewBtn').onclick=()=>{
  dayViewMode = dayViewMode==='list'?'timeline':'list';
  renderDay();
};

function renderDay(){
  dayTitle.innerText=selectedDate.toLocaleDateString('vi-VN');
  dayTasks.innerHTML='';
  dayTimeline.innerHTML='';
  const ymd=toYMD(selectedDate);

  const list=tasks.filter(t=>t.startDate<=ymd && t.endDate>=ymd);

  /* LIST VIEW (GI·ªÆ NGUY√äN + QUICK ACTIONS) */
  if(dayViewMode==='list'){
    dayTasks.classList.remove('hidden');
    dayTimeline.classList.add('hidden');

    list.forEach(task=>{
      const [text,color]=getStatus(task);
      dayTasks.innerHTML+=`
        <div class="border p-2 rounded">
          <b style="color:${ROLE_COLOR[task.role]}">${task.title}</b>
          <span class="status ml-2" style="background:${color}">${text}</span><br>
          ${task.startTime} ‚Üí ${task.endTime}
          <div class="mt-1 text-right text-xs">
            <button onclick="completeTask(${task.id})">‚úÖ</button>
            <button onclick="moveTomorrow(${task.id})">‚è©</button>
            <button onclick="cloneTask(${task.id})">üîÅ</button>
            <button onclick="editTask(${task.id})">‚úèÔ∏è</button>
            <button onclick="deleteTask(${task.id})">üóëÔ∏è</button>
          </div>
        </div>`;
    });
  }

  /* TIMELINE VIEW ‚Äì ADD v1.3.6 */
  else{
    dayTasks.classList.add('hidden');
    dayTimeline.classList.remove('hidden');

    for(let h=0;h<24;h++){
      const row=document.createElement('div');
      row.className='time-row';
      row.innerHTML=`<div class="time-label">${pad(h)}:00</div>`;
      dayTimeline.appendChild(row);
    }

    list.forEach(task=>{
      const sh=parseInt(task.startTime.split(':')[0]);
      const eh=parseInt(task.endTime.split(':')[0]);
      const block=document.createElement('div');
      block.className='task-block';
      block.style.background=ROLE_COLOR[task.role];
      block.style.top=`${sh*48}px`;
      block.style.height=`${Math.max(1,(eh-sh))*48}px`;
      block.textContent=task.title;
      dayTimeline.appendChild(block);
    });
  }
}

/* ======================================================
   QUICK ACTIONS ‚Äì ADD v1.3.6
====================================================== */
function completeTask(id){
  const t=tasks.find(x=>x.id===id);
  if(t){
    t.endDate=toYMD(new Date());
    localStorage.setItem('tasks',JSON.stringify(tasks));
    renderDay(); renderMonth();
  }
}
function moveTomorrow(id){
  const t=tasks.find(x=>x.id===id);
  if(!t) return;
  const d=new Date(t.startDate); d.setDate(d.getDate()+1);
  t.startDate=toYMD(d); t.endDate=toYMD(d);
  localStorage.setItem('tasks',JSON.stringify(tasks));
  renderDay(); renderMonth();
}
function cloneTask(id){
  const t=tasks.find(x=>x.id===id);
  if(!t) return;
  const d=new Date(t.startDate); d.setDate(d.getDate()+1);
  tasks.push({...t,id:Date.now(),startDate:toYMD(d),endDate:toYMD(d)});
  localStorage.setItem('tasks',JSON.stringify(tasks));
  renderDay(); renderMonth();
}

/* ======================================================
   WEEK VIEW ‚Äì ADD v1.3.6
====================================================== */
function changeWeek(step){
  weekAnchorDate.setDate(weekAnchorDate.getDate()+step*7);
  renderWeek();
}

function renderWeek(){
  weekGrid.innerHTML='';
  const start=new Date(weekAnchorDate);
  start.setDate(start.getDate()-((start.getDay()+6)%7));
  const end=new Date(start); end.setDate(start.getDate()+6);
  weekTitle.innerText=`${start.toLocaleDateString('vi-VN')} ‚Äì ${end.toLocaleDateString('vi-VN')}`;

  for(let i=0;i<7;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    const ymd=toYMD(d);

    const col=document.createElement('div');
    col.className='week-col';
    col.innerHTML=`<div class="week-head">${d.toLocaleDateString('vi-VN',{weekday:'short'})}<br>${d.getDate()}</div>`;

    tasks.filter(t=>t.startDate<=ymd && t.endDate>=ymd)
      .forEach(t=>{
        col.innerHTML+=`<div class="text-xs mt-1" style="color:${ROLE_COLOR[t.role]}">‚Ä¢ ${t.title}</div>`;
      });

    weekGrid.appendChild(col);
  }
}

/* ======================================================
   MODAL ACTIONS ‚Äì v1.3.5 (GI·ªÆ NGUY√äN)
====================================================== */
function openModal(){
  editingTaskId=null;
  modalTitle.innerText='‚ûï Th√™m c√¥ng vi·ªác';
  saveBtn.innerText='L∆∞u';
  modalBg.style.display='flex';

  const d=toYMD(selectedDate);
  mStartDate.value=d; mEndDate.value=d;

  const now=new Date();
  const h=pad(now.getHours());
  mStartTime.value=`${h}:00`;
  mEndTime.value=`${pad((now.getHours()+1)%24)}:00`;
}
function closeModal(){ modalBg.style.display='none'; }

function saveTask(){
  const mode=document.querySelector('input[name="mode"]:checked').value;
  const repeat=document.querySelector('input[name="repeat"]:checked').value;

  if(editingTaskId){
    const i=tasks.findIndex(t=>t.id===editingTaskId);
    if(i>-1){
      tasks[i]={...tasks[i],
        title:mTitle.value, role:mRole.value, detail:mDetail.value,
        startDate:mStartDate.value, endDate:mEndDate.value,
        startTime:mStartTime.value, endTime:mEndTime.value,
        mode, repeat,
        notify:{
          n1d:n1d.checked,n1h:n1h.checked,nStart:nStart.checked,
          nHalf:nHalf.checked,nEnd1d:nEnd1d.checked,
          nEnd1h:nEnd1h.checked,nEnd:nEnd.checked
        }
      };
    }
  } else {
    tasks.push({
      id:Date.now(),
      title:mTitle.value, role:mRole.value, detail:mDetail.value,
      startDate:mStartDate.value, endDate:mEndDate.value,
      startTime:mStartTime.value, endTime:mEndTime.value,
      mode, repeat,
      notify:{
        n1d:n1d.checked,n1h:n1h.checked,nStart:nStart.checked,
        nHalf:nHalf.checked,nEnd1d:nEnd1d.checked,
        nEnd1h:nEnd1h.checked,nEnd:nEnd.checked
      }
    });
  }

  localStorage.setItem('tasks',JSON.stringify(tasks));
  closeModal();
  renderMonth(); renderDay();
}

/* ======================================================
   INIT ‚Äì v1.3.6
====================================================== */
renderRoleFilter();
renderMonth();
renderDay();
</script>

</body>
</html>
